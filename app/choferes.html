<html>
  <head>
    <title>BAMTY - TRAFICO</title>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"  media="screen,projection"/>
    <meta charset="UTF-8"></meta>
    <style>
      #modal1{
        height: 800px;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <div>
        <ul id="slide-out" class="side-nav fixed teal">
          <div class="section">
            <img class="responsive-img" src="../img/logo.png"/>
          </div>
          <a href="./app.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-action-dashboard left"></i>Dashboard</a>
          <a href="./controldiario.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-action-assignment left"></i>Control - Diario</a>
          <a href="./rutas.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-maps-directions left"></i>Rutas</a>
          <a href="#" class="waves-effect waves-light btn black-text teal"><i class="mdi-social-person left"></i>Choferes</a>
          <a href="./vehiculos.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-maps-local-shipping left"></i>Vehiculos</a>

          <div class="section" style="margin-top: 300px;">
            <div class="row">
              <div class="col s6"><a href="../index.html" class="waves-effect waves-light btn black-text grey">logout</a></div>
              <div class="col s6"><a id="close" class="waves-effect waves-light btn black-text grey">exit</a></div>
            </div>
          </div>
       </ul>
       <a href="#" data-activates="slide-out" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
      </div>

      <div class="col s10 offset-s2">
        <nav>
          <div class="nav-wrapper">
            <a href="#" class="brand-logo center">Choferes</a>
          </div>
        </nav>
          <table class="hoverable" id="choferes">
              <thead>
              <tr>
                  <th data-field="nombre">Nombre</th>
                  <th data-field="direccion">Direccion</th>
                  <th data-field="telefono">Telefono</th>
                  <th data-field="area">Area</th>
                  <th data-field="fechaNacimiento">Fecha de Nacimiento</th>
                  <th data-field="fechaContratacion">Fecha de Contratacion</th>
              </tr>
              </thead>
              <tbody>
              </tbody>
          </table>
          <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
              <a href="#modal1" class="btn-floating btn-large teal tooltipped modal-trigger" data-position="left" data-delay="50" data-tooltip="Agregar chofer">
                  <i class="large mdi-content-add"></i></a>
          </div>
      </div>
    </div>

    <!-- modal form: alta rutas -->
    <div class="modal" id="modal1">
      <div class="modal-content">
        <h3 class="center">Registrar un nuevo chofer</h3>
        <form class="col s12" id="form-id">
          <div class="row">
            <div class="input-field col s12">
              <input name = "nombre" id="nombre" type="text" class="validate">
              <label for="nombre">Nombre completo</label>
            </div>
            <div class="input-field col s6">
              <input name = "direccion" id="direccion" type="text" class="validate">
              <label for="direccion">Direccion</label>
            </div>
            <div class="input-field col s6">
              <input name = "telefono" id="telefono" type="text" class="validate">
              <label for="telefono">Telefono</label>
            </div>
            <div class="input-field col s6">
              <input name = "nacimiento" id="nacimiento" type="date" class="datepicker">
              <label for="nacimiento">Fecha de Nacimiento</label>
            </div>
            <div class="input-field col s6">
              <input name = contratacion" id="contratacion" type="date" class="datepicker">
              <label for="contratacion">Fecha de Contratacion</label>
            </div>
          </div>
            <div class="modal-footer">
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat" id="submit-id" onclick="agregarABase()">Submit</a>
                <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">Cancel</a>
            </div>
        </form>
      </div>

    </div>
    <!-- Termino del modal -->

    <script>
        var db;
      window.onload = function() {
        $(document).ready(function() {
          $('select').material_select();
          $('.modal-trigger').leanModal({
            dismissible: false
          });
        });
        $('.datepicker').pickadate({
          selectMonths: true, // Creates a dropdown to control month
          selectYears: 15 // Creates a dropdown of 15 years to control year
        });
          //10 MB seran suficientes?
          db = openDatabase('BAM', '1.0', 'database', 10 * 1024 * 1024);
          db.transaction(function (tx) {
              tx.executeSql('CREATE TABLE IF NOT EXISTS empleados (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, Nombre, Direccion, Telefono, Area, FechaNacimiento, FechaContratacion)');
              //tx.executeSql('INSERT INTO empleados (id, Nombre, Direccion, Telefono, Area, FechaNacimiento, FechaContratacion) ' +
              //'VALUES (2, "Pepe", "Su casa", 012345678, "Trafico", "03/09/1974", "10/2/2007")');
          });
          db.transaction(function (tx) {
              tx.executeSql('SELECT * FROM empleados', [], function (tx, results) {
                  var len = results.rows.length, i;
                  $('#choferes').not(':first').not(':last').remove();
                  var html='';
                  for (i = 0; i < len; i++) {
                      //fill the table
                      html+='<tr data-id="'+(i+1)+'"><td>'+results.rows.item(i).Nombre+'</td><td>'+results.rows.item(i).Direccion+'</td><td>';
                      html+=results.rows.item(i).Telefono+'</td><td>'+results.rows.item(i).Area+'</td><td>';
                      html+=results.rows.item(i).FechaNacimiento+'</td><td>'+results.rows.item(i).FechaContratacion+'</td>';
                      html+='<td><button class="btn waves-effect waves-light center" onclick="editar(this)"><i class="mdi-editor-mode-edit"></i></button></td></tr>';
                  }
                  $('#choferes tbody').first().after(html);
              });
          });

      }

      <!-- Edicion de registro -->
      function trim(value) {
        var temp = value;
        var obj = /^(\s*)([\W\w]*)(\b\s*$)/;
        if (obj.test(temp)) { temp = temp.replace(obj, '$2');}
        var obj = /  /g;
        while (temp.match(obj)) { temp = temp.replace(obj, " ");}
        return temp;
      }

      function getTextWidth(texto) {
        var ancho = 150;

        if(trim(texto) == "") {
            return ancho;
        }

        var span = document.createElement("span");
        span.style.visibility = "hidden";
        span.style.position = "absolute";
        span.appendChild(document.createTextNode(texto));
        document.getElementsByTagName("body")[0].appendChild(span);
        ancho = span.offsetWidth;
        document.getElementsByTagName("body")[0].removeChild(span);
        span = null;

        return ancho;
      }
        function agregarABase(){
            var form = document.getElementById("form-id");
            var nom = trim(form.nombre.value);
            var dir = trim(form.direccion.value);
            var tel = trim(form.telefono.value);
            var nac = trim(form.nacimiento.value);
            var con = trim(form.nacimiento.value);
            if(nom == "" || dir == "" || tel=="" || nac == "" || con ==""){
                alert("Por favor llena todos los campos");
                return false;
            }
            db.transaction(function (tx) {
                tx.executeSql('INSERT INTO empleados VALUES (NULL, ?, ?, ?, ?, ?, ?);',
                        [nom, dir, tel, "Trafico", nac, con]);
            });
            return true;

        }

      function editar(obj) {
        var nombre = null;
        var direccion = null;
        var telefono = null;
        var fechaNacimiento = null;
        var fechaContratacion = null;
        var fila = obj.parentNode.parentNode;
        var campoNombre = fila.children[0];
        var campoDireccion = fila.children[1];
        var campoTelefono = fila.children[2];
        var campoFechaN = fila.children[4];
        var campoFechaC = fila.children[5];


        nombre = document.createElement("input");
        if(campoNombre.innerText) {
          nombre.value = campoNombre.innerText;
        } else {
          nombre.value = campoNombre.textContent;
        }
        nombre.style.width = getTextWidth(nombre.value) + 30 + "px";
        campoNombre.replaceChild(nombre, campoNombre.firstChild);


        direccion = document.createElement("input");
        if(campoDireccion.innerText) {
          direccion.value = campoDireccion.innerText;
        } else {
          direccion.value = campoDireccion.textContent;
        }
        direccion.style.width = getTextWidth(direccion.value) + 30 + "px";
        campoDireccion.replaceChild(direccion, campoDireccion.firstChild);


        telefono = document.createElement("input");
        if(campoTelefono.innerText) {
          telefono.value = campoTelefono.innerText;
        } else {
          telefono.value = campoTelefono.textContent;
        }
        telefono.style.width = getTextWidth(telefono.value) + 30 + "px";
        campoTelefono.replaceChild(telefono, campoTelefono.firstChild);

        fechaNacimiento = document.createElement("input");
        if(campoFechaN.innerText) {
          fechaNacimiento.value = campoFechaN.innerText;
        } else {
          fechaNacimiento.value = campoFechaN.textContent;
        }
        fechaNacimiento.style.width = getTextWidth(fechaNacimiento.value) + 30 + "px";
        campoFechaN.replaceChild(fechaNacimiento, campoFechaN.firstChild);

        fechaContratacion = document.createElement("input");
        if(campoFechaC.innerText) {
          fechaContratacion.value = campoFechaC.innerText;
        } else {
          fechaContratacion.value = campoFechaC.textContent;
        }
        fechaContratacion.style.width = getTextWidth(fechaContratacion.value) + 30 + "px";
        campoFechaC.replaceChild(fechaContratacion, campoFechaC.firstChild);
        obj.className = "btn waves-effect waves-light center green";
        obj.firstChild.className = "mdi-content-save";
        obj.onclick = function salir() {
          guardarCambios(obj, nombre.value, direccion.value, telefono.value, fechaNacimiento.value, fechaContratacion.value);
          delete nombre;
          delete direccion;
          delete telefono;
          delete fechaNacimiento;
          delete fechaContratacion;
        }
      }

      function guardarCambios(obj, valorNombre, valorDir, valorTel, valorFechaN, valorFechaC) {
        var fila = obj.parentNode.parentNode;
        var nombre = fila.children[0];
        var direccion = fila.children[1];
        var telefono = fila.children[2];
        var fechaNacimiento = fila.children[4];
        var fechaContratacion = fila.children[5];
        nombre.replaceChild(document.createTextNode(valorNombre), nombre.firstChild);
        direccion.replaceChild(document.createTextNode(valorDir), direccion.firstChild);
        telefono.replaceChild(document.createTextNode(valorTel), telefono.firstChild);
        fechaNacimiento.replaceChild(document.createTextNode(valorFechaN), fechaNacimiento.firstChild);
        fechaContratacion.replaceChild(document.createTextNode(valorFechaC), fechaContratacion.firstChild);
          var ID = obj.parentNode.parentNode.getAttribute("data-id");
          db.transaction(function (tx) {
              tx.executeSql('UPDATE empleados SET Nombre =?, Direccion=?, Telefono =?, FechaNacimiento=?, FechaContratacion=? WHERE id =?',
              [valorNombre, valorDir, valorTel, valorFechaN, valorFechaC, parseInt(ID)]);
          });


        obj.className = "btn waves-effect waves-light center";
        obj.firstChild.className = "mdi-editor-mode-edit";
        obj.onclick=function() {editar(this)};
      }

    </script>
    <script src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/materialize.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
      var path = './app/';
      var fs = require('fs');

      fs.watch(path, function() {
        if (location)
          location.reload();
      });
    </script>
  </body>
</html>
