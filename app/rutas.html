<html>
  <head>
    <title>BAMTY - TRAFICO</title>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="../css/materialize.min.css"  media="screen,projection"/>
    <meta charset="UTF-8"></meta>
    <style>
      #modal1{
        height: 800px;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <div>
        <ul id="slide-out" class="side-nav fixed teal">
          <div class="section">
            <img class="responsive-img" src="../img/logo.png"/>
          </div>
          <a href="./app.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-action-dashboard left"></i>Dashboard</a>
          <a href="./controldiario.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-action-assignment left"></i>Control - Diario</a>
          <a href="#" class="waves-effect waves-light btn black-text teal"><i class="mdi-maps-directions left"></i>Rutas</a>
          <a href="./choferes.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-social-person left"></i>Choferes</a>
          <a href="./vehiculos.html" class="waves-effect waves-light btn black-text teal"><i class="mdi-maps-local-shipping left"></i>Vehiculos</a>

          <div class="section" style="margin-top: 300px;">
            <div class="row">
              <div class="col s6"><a href="../index.html" class="waves-effect waves-light btn black-text grey">logout</a></div>
              <div class="col s6"><a id="close" class="waves-effect waves-light btn black-text grey">exit</a></div>
            </div>
          </div>
       </ul>
       <a href="#" data-activates="slide-out" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
      </div>

      <div class="col s10 offset-s2">
        <nav>
          <div class="nav-wrapper teal">
            <a href="#" class="brand-logo center">Rutas disponibles</a>
          </div>
        </nav>
        <table class="hoverable" id="calendario">
          <thead>
            <tr>
                <th data-field="id">Ruta</th>
                <th data-field="tienda">Tienda Sucursal</th>
                <th data-field="frecuencia">Tipo de Visita</th>
                <th></th>
                <th></th>
                <th data-field="lunes">Lunes</th>
                <th data-field="martes">Martes</th>
                <th data-field="miercoles">Miércoles</th>
                <th data-field="jueves">Jueves</th>
                <th data-field="viernes">Viernes</th>
                <th data-field="sabado">Sábado</th>
                <th data-field="domingo">Domingo</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
          <a href="#modal1" class="btn-floating btn-large teal tooltipped modal-trigger" data-position="left" data-delay="50" data-tooltip="Agregar ruta">
            <i class="large mdi-content-add"></i></a>
        </div>
      </div>
    </div>

  <!-- modal form: alta rutas -->
    <div class="modal" id="modal1">
      <div class="modal-content">
        <h3 class="center">Registrar una nueva ruta</h3>
        <form class="col s12" id="form-id">
          <div class="row">
            <div class="input-field col s12">
              <label>Ruta</label>
              <br/>
              <p>
                <input class="rutaOpcion" name="group1" type="radio" id="test1" value="Si" />
                <label for="test1">Ruta existente</label>
              </p>
              <p>
                <input class="rutaOpcion" name="group1" type="radio" id="test2" value="No"/>
                <label for="test2">Nueva ruta</label>
              </p>
            </div>
            <div class="input-field col s12" id="escribirRuta">
              <input id="ruta" type="text" class="validate" name="ruta">
              <label for="ruta">Ruta</label>
            </div>
            <div class="input-field col s12" id="selectRuta">
              <select id="ruta" class="selectRutasBase browser-default" name="ruta">
              </select>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6">
              <input id="tienda" type="text" class="validate" name="tienda">
              <label for="tienda">Tienda Sucursal</label>
            </div>
            <div class="input-field col s6">
              <p class="tooltipped" data-tooltip="Escoger todos los días que se visitara la sucursal" data-positon="left" data-delay="50">Tipo de Visita</p>
              <input type="checkbox" class="filled-in" id="lunes" name="lunes" value ="Lu"/>
              <label for="lunes">Lunes</label>
              <br/>
              <input type="checkbox" class="filled-in" id="martes" name="martes" value ="Mar"/>
              <label for="martes">Martes</label>
              <br/>
              <input type="checkbox" class="filled-in" id="miercoles" name="miercoles" value ="Mi"/>
              <label for="miercoles">Miércoles</label>
              <br/>
              <input type="checkbox" class="filled-in" id="jueves" name="jueves" value ="Jue"/>
              <label for="jueves">Jueves</label>
              <br/>
              <input type="checkbox" class="filled-in" id="viernes" name="viernes" value ="Vi"/>
              <label for="viernes">Viernes</label>
              <br/>
              <input type="checkbox" class="filled-in" id="sabado" name="sabado" value ="Sab"/>
              <label for="sabado">Sábado</label>
              <br/>
              <input type="checkbox" class="filled-in" id="domingo" name="domingo" value ="Dom"/>
              <label for="domingo">Domingo</label>
            </div>
          </div>
            <div class="modal-footer">
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat" id="submit-id" onclick="agregarABase()">Submit</a>
                <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">Cancel</a>
            </div>
        </form>
      </div>

    </div>
  <!-- Termino del modal -->

    <script src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/materialize.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
      var path = './app/';
      var fs = require('fs');

      fs.watch(path, function() {
        if (location)
          location.reload();
      });
    </script>
    <script>
      var db;
      window.onload = function() {
        inicializarTabla(function() {
          calendario();
          $("#calendario").on("click","button",function() {
          if($(this).hasClass('editar-fila')){
            var fila = $(this).parent().parent();
            var items = [null, null, null];
            fila.children().each(function(index, el) {
             if ($(this).data("modify") != "0" && index < 3) {
                console.log($(this).html());
                var txt = $(this).html();
                $(this).html("<input value='"+txt+"'/>")
              };
            });
            $(this).removeClass('editar-fila').addClass('green guardar-cambios');
            $(this).children().removeClass('mdi-editor-mode-edit').addClass('mdi-content-save');
          }
          else if ($(this).hasClass('guardar-cambios')){
            var fila = $(this).parent().parent();
            fila.children().each(function(index, el) {
              if ($(this).data("modify") != "0" && index < 3) {
                  var newval = $(this).children().val();
                  $(this).html(newval);
              };
            });	
            $(this).removeClass('green guardar-cambios').addClass('editar-fila');
            $(this).children().removeClass('mdi-content-save').addClass('mdi-editor-mode-edit');
            var fila = $(this).parent().parent();
            guardarCambios(fila,function() { location.reload();});
          }
          else if($(this).hasClass('borrar-fila')) {
				var fila = $(this).parent().parent();		
				var ID = fila.attr('data-id');
				db.transaction(function (tx) {
				  tx.executeSql('DELETE FROM visitas WHERE id=' + ID);
        		});
				fila.html("");
            }
          });
          db.transaction(function (tx) {
              tx.executeSql('SELECT DISTINCT Nombre FROM visitas ORDER BY Nombre ASC', [], function (tx, results) {
                var len = results.rows.length, i;
                //$('#selectRuta').not(':first').not(':last').remove();
                var html='<option value="" disabled selected>Escoje una ruta</option>';
                for (i = 0; i < len; i++) {
                  html+='<option value="'+results.rows.item(i).Nombre+'">'+results.rows.item(i).Nombre+'</option>';
                }
                $('#selectRuta select').append(html);
              });
          });
        });
      }
      function inicializarTabla(callback) {
          db = openDatabase('BAM', '1.0', 'database', 10 * 1024 * 1024);
          db.transaction(function (tx) {
              tx.executeSql('CREATE TABLE IF NOT EXISTS visitas (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, Nombre, TiendaSucursal, TipoVisita)');
              tx.executeSql('INSERT INTO visitas (id, Nombre, TiendaSucursal, TipoVisita) ' +
              'VALUES (1, "R1", "HEB Gonzalitos", "Lu,Jue")');
              tx.executeSql('INSERT INTO visitas (id, Nombre, TiendaSucursal, TipoVisita) ' +
              'VALUES (2, "R2", "HEB Chipinque", "Diaria")');
          });
          db.transaction(function (tx) {
              tx.executeSql('SELECT * FROM visitas ORDER BY Lower(Nombre) ASC', [], function (tx, results) {
                var len = results.rows.length, i;
                $('#calendario').not(':first').not(':last').remove();
                var html='';
                for (i = 0; i < len; i++) {
                  //fill the table
                  //alert(results.rows.item(i).Nombre);
                  html+='<tr data-id="'+results.rows.item(i).id+'"><td>'+results.rows.item(i).Nombre+'</td><td>'+results.rows.item(i).TiendaSucursal+'</td><td>';
                  html+=results.rows.item(i).TipoVisita+'</td>';
                  html+='<td data-modify="0"><button class="btn waves-effect waves-light center editar-fila"><i class="mdi-editor-mode-edit"></i></button></td>' + 
                	'<td data-modify="0"><button class="btn waves-effect waves-light center red borrar-fila"><i class="mdi-action-delete"></i></button></td></tr>';
                }
                $('#calendario tbody').append(html);
                callback();
              });
          });
      }
      function calendario() {
        var length = document.getElementById("calendario").rows.length;
        for(i=1; i<length; i++) {
          var fila = document.getElementById("calendario").rows[i].cells;
          var dias = fila[2].textContent;
          fila = document.getElementById("calendario").rows[i];
          if(dias.search("Diaria") >=0) {
            for(j=0; j<7; j++) {
              x = fila.insertCell(-1);
              x.style.backgroundColor = "#0277bd";
            }
          } else {
            x = fila.insertCell(-1);
            if(dias.search("Lu") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Mar") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Mi") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Jue") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Vi") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Sab") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
            x = fila.insertCell(-1);
            if(dias.search("Dom") >= 0) {
               x.style.backgroundColor = "#0277bd";
            }
          }
        }
      }
      $(window).ready(function() {
        $('select').material_select();
        $('.modal-trigger').leanModal({
          dismissible: false
        });
        $("#selectRuta, #escribirRuta").css("display","none");
        $(".rutaOpcion").on("click",function(){
          if ($('input[name=group1]:checked').val() == "No") {
            $("#escribirRuta").slideDown("fast"); //Slide Down Effect
            $("#selectRuta").slideUp("fast"); //Slide Down Effect
          }
          if ($('input[name=group1]:checked').val() == "Si"){
            $("#selectRuta").slideDown("fast"); 
            $("#escribirRuta").slideUp("fast");
          }
        });
      });

      function trim(value) {
          var temp = value;
          var obj = /^(\s*)([\W\w]*)(\b\s*$)/;
          if (obj.test(temp)) { temp = temp.replace(obj, '$2');}
          var obj = /  /g;
          while (temp.match(obj)) { temp = temp.replace(obj, " ");}
          return temp;
      }
      function agregarABase(){
          var form = document.getElementById("form-id");
          if ( $('#selectRuta').css('display') == 'none' ){
            var ruta = form.ruta[0].value;
          } else {
            var ruta = form.ruta[1].value;
          }
          //var ruta = form.ruta.value;
          var tienda = trim(form.tienda.value);
          var visitas = "";
          if(form.lunes.checked){
              visitas+="Lu";
          }
          if(form.martes.checked){
              if(visitas!=""){
                  visitas+=", Mar";
              }
              else{
                  visitas+="Mar";
              }
          }
          if(form.miercoles.checked){
              if(visitas!=""){
                  visitas+=", Mi";
              }
              else{
                  visitas+="Mi";
              }
          }
          if(form.jueves.checked){
              if(visitas!=""){
                  visitas+=", Jue";
              }
              else{
                  visitas+="Jue";
              }
          }
          if(form.viernes.checked){
              if(visitas!=""){
                  visitas+=", Vi";
              }
              else{
                  visitas+="Vi";
              }
          }
          if(form.sabado.checked){
              if(visitas!=""){
                  visitas+=", Sab";
              }
              else{
                  visitas+="Sab";
              }
          }
          if(form.domingo.checked){
              if(visitas!=""){
                  visitas+=", Dom";
              }
              else{
                  visitas+="Dom";
              }
          }

          if(visitas == "Lu, Mar, Mi, Jue, Vi, Sab, Dom"){
              visitas="Diaria";
          }

          if(ruta == "" || tienda == "" || visitas == ""){
              alert("Por favor llena todos los campos");
              return false;
          }
          db.transaction(function (tx) {
              tx.executeSql('INSERT INTO visitas VALUES (NULL, ?, ?, ?);',
                      [ruta, tienda, visitas]);
          });
        location.reload();
          return true;
      }
      function guardarCambios(fila, callback) {
        fila = fila[0];
        var ruta = fila.children[0].innerText;
        var tienda = fila.children[1].innerText;
        var freq = fila.children[2].innerText;
        var ID = fila.getAttribute("data-id");
        db.transaction(function (tx) {
          tx.executeSql('UPDATE visitas SET Nombre =?, TiendaSucursal=?, TipoVisita=? WHERE id =?',
                    [ruta, tienda, freq, parseInt(ID)]);
          callback();
        });
        return true;
      }
    </script>
  </body>
</html>
